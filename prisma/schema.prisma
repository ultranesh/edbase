generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum UserRole {
  SUPERADMIN
  ADMIN
  DEPARTMENT_HEAD
  CHIEF_COORDINATOR    // Главный координатор (бывший COORDINATOR_MANAGER)
  CHIEF_CURATOR        // Главный куратор
  CURATOR
  COORDINATOR
  TEACHER
  PARENT
  ONLINE_MENTOR
  STUDENT
}

enum Gender {
  MALE
  FEMALE
}

enum Citizenship {
  KZ
  FOREIGN
}

enum StudentStatus {
  PENDING_APPROVAL  // Ожидает подтверждения куратором
  ACTIVE            // Активный
  FROZEN            // На заморозке
  REFUND            // Возврат
  GRADUATED         // Закончил обучение
  INACTIVE          // Неактивен
  EXPELLED          // Отчислен
}

enum TeacherStatus {
  ACTIVE      // Активный
  SUSPENDED   // Отстранен
  RESERVE     // Резерв
}

enum SalaryFormat {
  HOURLY    // Почасовая оплата
  MONTHLY   // Месячная зарплата
}

enum DifficultyLevel {
  BEGINNER
  ELEMENTARY
  PRE_INTERMEDIATE
  INTERMEDIATE
  UPPER_INTERMEDIATE
  ADVANCED
}

enum LessonType {
  THEORETICAL
  PRACTICAL
  LAB
  TEST
  EXAM
}

enum HomeworkStatus {
  PENDING
  SUBMITTED
  CHECKED
  LATE
}

enum TestType {
  QUIZ
  MIDTERM
  FINAL
  MOCK_EXAM
}

enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  KASPI
  HALYK
}

enum ContractStatus {
  DRAFT
  ACTIVE
  COMPLETED
  TERMINATED
}

enum TeacherCategory {
  INTERN           // Стажер
  NO_CATEGORY      // Без категории
  FIRST_CATEGORY   // Первая категория
  HIGHEST_CATEGORY // Высшая категория
  EXPERT           // Эксперт
}

enum TaskFormat {
  NISH      // НИШ
  BIL       // БИЛ
  RFMSH     // РФМШ
  ENT       // ЕНТ
  OLYMPIAD  // Олимпиадная
  SAT       // SAT
}

enum Guarantee {
  NONE
  FIFTY_PERCENT
  EIGHTY_PERCENT
  HUNDRED_PERCENT
}

enum StudyFormat {
  ONLINE_GROUP           // Онлайн группа
  OFFLINE_GROUP          // Очная группа
  ONLINE_INDIVIDUAL      // Онлайн индивидуально
  OFFLINE_INDIVIDUAL     // Очно индивидуально
}

enum PaymentPlan {
  ONE_TRANCHE
  TWO_TRANCHES
  THREE_TRANCHES
}

enum ParentDocumentType {
  ID_CARD        // Удостоверение личности
  RK_PASSPORT    // Паспорт гражданина РК
  FOREIGN        // Иностранный документ
}

enum StudySchedule {
  PSP      // Пн-Ср-Пт
  VCS      // Вт-Чт-Сб
  CUSTOM   // Особый (выбранные дни)
}

enum ResourceType {
  BOOK
  VIDEO
  AUDIO
  DOCUMENT
  PRESENTATION
  OTHER
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum NotificationType {
  INFO
  WARNING
  SUCCESS
  ERROR
}

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum TransactionType {
  EARNED
  SPENT
  BONUS
  REFUND
}

enum TimeOfDay {
  MORNING   // Утро - M
  AFTERNOON // Обед - A
  EVENING   // Вечер - E
}

// ==========================================
// REFERENCE TABLES (Справочные таблицы)
// ==========================================

// Языки обучения
model RefLanguage {
  id        String   @id @default(uuid())
  name      String   @unique  // казахский, русский, английский
  nameKz    String?  // Қазақша
  nameRu    String?  // По-русски
  nameEn    String?  // In English
  code      String   @unique  // Q, R, E
  orderIndex Int     @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  students  Student[]
  groups    Group[]
  crmLeads  CrmLead[] @relation("CrmLeadStudyLanguage")

  @@map("ref_languages")
}

// Классы обучения (0-11, выпускник)
model RefGradeLevel {
  id        String   @id @default(uuid())
  name      String   @unique  // "0 класс", "1 класс", ... "11 класс", "Выпускник"
  nameKz    String?
  nameRu    String?
  nameEn    String?
  code      String   @unique  // 0, 1, 2, ... 11, A (для выпускника)
  orderIndex Int
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  students  Student[]
  groups    Group[]
  crmLeads  CrmLead[]

  @@map("ref_grade_levels")
}

// Направления/Цели обучения
model RefStudyDirection {
  id        String   @id @default(uuid())
  name      String   @unique  // СС, ЕНТ, IELTS, Продленка, etc.
  nameKz    String?
  nameRu    String?
  nameEn    String?
  code      String   @unique
  orderIndex Int     @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  students  Student[]
  groups    Group[]

  @@map("ref_study_directions")
}

// Предметы
model RefSubject {
  id        String   @id @default(uuid())
  code      String?
  nameKz    String?
  nameRu    String?
  nameEn    String?
  icon      String?
  orderIndex Int     @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  topics           RefTopic[]
  studentSubjects  StudentSubject[]
  groupSubjects    GroupSubject[]
  teacherSubjects  TeacherSubject[]

  @@map("ref_subjects")
}

// Темы (связаны с предметами)
model RefTopic {
  id        String   @id @default(uuid())
  subjectId String
  name      String
  nameKz    String?
  nameRu    String?
  nameEn    String?
  orderIndex Int     @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subject   RefSubject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  subtopics RefSubtopic[]

  @@index([subjectId])
  @@map("ref_topics")
}

// Подтемы (связаны с темами)
model RefSubtopic {
  id        String   @id @default(uuid())
  topicId   String
  name      String
  nameKz    String?
  nameRu    String?
  nameEn    String?
  orderIndex Int     @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  topic     RefTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@index([topicId])
  @@map("ref_subtopics")
}

// Области/Регионы
model RefRegion {
  id         String   @id @default(uuid())
  code       String?  @unique
  name       String   @unique
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  cities    RefCity[]
  crmLeads  CrmLead[]

  @@map("ref_regions")
}

// Города
model RefCity {
  id         String   @id @default(uuid())
  code       String?  @unique
  name       String   @unique
  nameKz     String?
  nameRu     String?
  nameEn     String?
  regionId   String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  region    RefRegion? @relation(fields: [regionId], references: [id])
  schools   RefSchool[]
  students  Student[]
  crmLeads  CrmLead[]

  @@index([regionId])
  @@map("ref_cities")
}

// Школы (связаны с городами)
model RefSchool {
  id        String   @id @default(uuid())
  cityId    String
  name      String
  nameKz    String?
  nameRu    String?
  nameEn    String?
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  city      RefCity   @relation(fields: [cityId], references: [id], onDelete: Cascade)
  students  Student[]
  crmLeads  CrmLead[]

  @@index([cityId])
  @@map("ref_schools")
}

// Особенности (ЗПР и т.д.)
model RefSpecialNeed {
  id          String   @id @default(uuid())
  name        String   @unique
  nameKz      String?
  nameRu      String?
  nameEn      String?
  description String?
  descriptionKz String?
  descriptionRu String?
  descriptionEn String?
  orderIndex  Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentSpecialNeeds StudentSpecialNeed[]

  @@map("ref_special_needs")
}

// Индексы групп (греческие буквы)
model RefGroupIndex {
  id        String   @id @default(uuid())
  name      String   @unique  // Alpha, Beta, Gamma, etc.
  symbol    String   @unique  // α, β, γ или Alfa, Beta и т.д.
  orderIndex Int     @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  groups    Group[]

  @@map("ref_group_indexes")
}

// Категории преподавателей
model RefTeacherCategory {
  id        String   @id @default(uuid())
  name      String   @unique  // Стажер, Без категорий, etc.
  nameKz    String?
  nameRu    String?
  nameEn    String?
  orderIndex Int     @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teachers  Teacher[]

  @@map("ref_teacher_categories")
}

// Роли пользователей (справочник для enum UserRole)
model RefUserRole {
  id         String   @id @default(uuid())
  code       String   @unique  // SUPERADMIN, ADMIN, etc. - должен соответствовать enum UserRole
  name       String             // Отображаемое имя
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_user_roles")
}

// Пол (справочник для enum Gender)
model RefGender {
  id         String   @id @default(uuid())
  code       String   @unique  // MALE, FEMALE - должен соответствовать enum Gender
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_genders")
}

// Гражданство (справочник для enum Citizenship)
model RefCitizenship {
  id         String   @id @default(uuid())
  code       String   @unique  // KZ, FOREIGN - должен соответствовать enum Citizenship
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_citizenships")
}

// Формат обучения (справочник для enum StudyFormat)
model RefStudyFormat {
  id         String   @id @default(uuid())
  code       String   @unique  // ONLINE_GROUP, OFFLINE_GROUP, etc. - должен соответствовать enum StudyFormat
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_study_formats")
}

// Гарантия (справочник для enum Guarantee)
model RefGuarantee {
  id         String   @id @default(uuid())
  code       String   @unique  // NONE, FIFTY_PERCENT, etc. - должен соответствовать enum Guarantee
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_guarantees")
}

// Расписание занятий (справочник для enum StudySchedule)
model RefStudySchedule {
  id         String   @id @default(uuid())
  code       String   @unique  // PSP, VCS, CUSTOM - должен соответствовать enum StudySchedule
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_study_schedules")
}

// Тип документа родителя (справочник для enum ParentDocumentType)
model RefParentDocumentType {
  id         String   @id @default(uuid())
  code       String   @unique  // ID_CARD, RK_PASSPORT, FOREIGN - должен соответствовать enum ParentDocumentType
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_parent_document_types")
}

// Статус студента (справочник для enum StudentStatus)
model RefStudentStatus {
  id         String   @id @default(uuid())
  code       String   @unique  // PENDING_APPROVAL, ACTIVE, etc.
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  color      String?  // Цвет для отображения в UI
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_student_statuses")
}

// Статус учителя (справочник для enum TeacherStatus)
model RefTeacherStatus {
  id         String   @id @default(uuid())
  code       String   @unique  // ACTIVE, SUSPENDED, RESERVE
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  color      String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_teacher_statuses")
}

// Статус платежа (справочник для enum PaymentStatus)
model RefPaymentStatus {
  id         String   @id @default(uuid())
  code       String   @unique  // PENDING, PAID, OVERDUE, CANCELLED
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  color      String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_payment_statuses")
}

// Статус контракта (справочник для enum ContractStatus)
model RefContractStatus {
  id         String   @id @default(uuid())
  code       String   @unique  // DRAFT, ACTIVE, COMPLETED, TERMINATED
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  color      String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_contract_statuses")
}

// Статус домашнего задания (справочник для enum HomeworkStatus)
model RefHomeworkStatus {
  id         String   @id @default(uuid())
  code       String   @unique  // PENDING, SUBMITTED, CHECKED, LATE
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  color      String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_homework_statuses")
}

// Статус заказа (справочник для enum OrderStatus)
model RefOrderStatus {
  id         String   @id @default(uuid())
  code       String   @unique  // PENDING, COMPLETED, CANCELLED
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  color      String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_order_statuses")
}

// Тип теста (справочник для enum TestType)
model RefTestType {
  id         String   @id @default(uuid())
  code       String   @unique  // QUIZ, MIDTERM, FINAL, MOCK_EXAM
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_test_types")
}

// Тип вопроса (справочник для enum QuestionType)
model RefQuestionType {
  id         String   @id @default(uuid())
  code       String   @unique  // SINGLE_CHOICE, MULTIPLE_CHOICE, etc.
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_question_types")
}

// Формат задания (справочник для enum TaskFormat)
model RefTaskFormat {
  id         String   @id @default(uuid())
  code       String   @unique  // NISH, BIL, RFMSH, ENT, OLYMPIAD, SAT
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_task_formats")
}

// Тип урока (справочник для enum LessonType)
model RefLessonType {
  id         String   @id @default(uuid())
  code       String   @unique  // THEORETICAL, PRACTICAL, LAB, TEST, EXAM
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_lesson_types")
}

// Уровень сложности (справочник для enum DifficultyLevel)
model RefDifficultyLevel {
  id         String   @id @default(uuid())
  code       String   @unique  // BEGINNER, ELEMENTARY, etc.
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_difficulty_levels")
}

// Формат зарплаты (справочник для enum SalaryFormat)
model RefSalaryFormat {
  id         String   @id @default(uuid())
  code       String   @unique  // HOURLY, MONTHLY
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_salary_formats")
}

// Способ оплаты (справочник для enum PaymentMethod)
model RefPaymentMethod {
  id         String   @id @default(uuid())
  code       String   @unique  // CASH, CARD, TRANSFER, KASPI, HALYK
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  commission Float?   @default(0)
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_payment_methods")
}

// План оплаты (справочник для enum PaymentPlan)
model RefPaymentPlan {
  id         String   @id @default(uuid())
  code       String   @unique  // ONE_TRANCHE, TWO_TRANCHES, THREE_TRANCHES
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_payment_plans")
}

// Время суток (справочник для enum TimeOfDay)
model RefTimeOfDay {
  id         String   @id @default(uuid())
  code       String   @unique  // MORNING, AFTERNOON, EVENING
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_time_of_day")
}

// Тип ресурса (справочник для enum ResourceType)
model RefResourceType {
  id         String   @id @default(uuid())
  code       String   @unique  // BOOK, VIDEO, AUDIO, DOCUMENT, PRESENTATION, OTHER
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  icon       String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_resource_types")
}

// Тип уведомления (справочник для enum NotificationType)
model RefNotificationType {
  id         String   @id @default(uuid())
  code       String   @unique  // INFO, WARNING, SUCCESS, ERROR
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  color      String?
  icon       String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_notification_types")
}

// Статус сообщения (справочник для enum MessageStatus)
model RefMessageStatus {
  id         String   @id @default(uuid())
  code       String   @unique  // SENT, DELIVERED, READ
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_message_statuses")
}

// Тип транзакции (справочник для enum TransactionType)
model RefTransactionType {
  id         String   @id @default(uuid())
  code       String   @unique  // EARNED, SPENT, BONUS, REFUND
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_transaction_types")
}

// Формат сгенерированного теста (справочник для enum GeneratedTestFormat)
model RefGeneratedTestFormat {
  id         String   @id @default(uuid())
  code       String   @unique  // TEST, EXAM
  name       String
  nameKz     String?
  nameRu     String?
  nameEn     String?
  orderIndex Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ref_generated_test_formats")
}

// ==========================================
// CORE TABLES
// ==========================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  iin           String?   @unique
  password      String
  plainPassword String?
  switchToken   String?
  firstName     String
  lastName      String
  middleName    String?
  phone         String?
  sipNumber     String?
  role          UserRole
  avatar        String?
  pin           String?
  avatarLocked  Boolean   @default(false)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLogin     DateTime?
  lastSeen      DateTime?

  student       Student?
  teacher       Teacher?
  parent        Parent?
  curator       Curator?

  sentMessages     Message[]         @relation("SentMessages")
  chatParticipants ChatParticipant[]
  notifications    Notification[]
  createdTests     Test[]
  loginSessions    LoginSession[]

  // Generated Tests
  createdGeneratedTests GeneratedTest[]      @relation("CreatedGeneratedTests")
  sharedGeneratedTests  GeneratedTestShare[] @relation("SharedGeneratedTests")

  // Payment relations
  recordedPayments  Payment[] @relation("RecordedPayments")
  partnerPayments   Payment[] @relation("PartnerPayments")
  confirmedPayments Payment[] @relation("ConfirmedPayments")

  // CRM
  crmLeads          CrmLead[] @relation("CrmLeads")

  // WhatsApp
  whatsappMessages  WhatsAppMessage[] @relation("WhatsAppSentBy")

  // Social (Messenger + Instagram)
  socialMessages    SocialMessage[]   @relation("SocialSentBy")

  @@index([role, isActive])
  @@map("users")
}

// Сеансы входа пользователей
model LoginSession {
  id              String    @id @default(uuid())
  userId          String
  ipAddress       String?
  userAgent       String?
  deviceType      String?   // mobile, tablet, desktop
  browser         String?
  browserVersion  String?
  os              String?
  deviceModel     String?
  network         String?   // Wi-Fi, Cellular, Ethernet, etc.
  isp             String?   // Провайдер / название сети
  org             String?   // Организация (может отличаться от ISP)
  asName          String?   // Автономная система
  city            String?   // Город по IP
  regionName      String?   // Область/регион по IP
  country         String?   // Страна по IP
  lat             Float?    // Широта
  lon             Float?    // Долгота
  timezone        String?   // Часовой пояс по IP
  isProxy         Boolean?  // VPN/Proxy
  isHosting       Boolean?  // Хостинг/дата-центр
  isMobileNetwork Boolean?  // Мобильная сеть по IP
  screenResolution String?  // Разрешение экрана (напр. 1920x1080)
  language        String?   // Язык браузера
  clientTimezone  String?   // Часовой пояс клиента
  connectionSpeed String?   // Скорость соединения (напр. "10 Mbps")
  loginAt         DateTime  @default(now())
  logoutAt        DateTime?

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, loginAt])
  @@map("login_sessions")
}

// Куратор
model Curator {
  id        String   @id @default(uuid())
  userId    String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  branches  BranchCurator[]

  @@map("curators")
}

model Student {
  id               String        @id @default(uuid())
  userId           String        @unique
  dateOfBirth      DateTime?
  gender           Gender?
  address          String?
  parentId         String?
  status           StudentStatus @default(PENDING_APPROVAL)
  enrollmentDate   DateTime      @default(now())
  balance          Int           @default(0)
  totalEarned      Int           @default(0)

  // Contract
  contractNumber   String?       @unique
  contractConfirmed Boolean @default(false)
  contractConfirmedAt DateTime?
  contractConfirmedBy String?

  // Personal info
  studentIIN       String?
  citizenship      Citizenship @default(KZ)
  parentIIN        String?
  parentName       String?
  parentPhone      String?
  studentPhone     String?
  parentDocumentType   ParentDocumentType?
  parentDocumentNumber String?

  // Reference relations
  gradeLevelId     String?
  languageId       String?
  studyDirectionId String?
  cityId           String?
  schoolId         String?
  branchId         String?

  // Study details
  studyFormat      StudyFormat?
  guarantee        Guarantee?
  studySchedule    StudySchedule?
  customDays       String[]        @default([])
  allergy          String?

  // Subscription details
  standardMonths   Int           @default(0)
  bonusMonths      Int           @default(0)
  intensiveMonths  Int           @default(0)
  freezeDays       Int           @default(0)
  freezeEndDate    DateTime?
  ertisDrops       Int           @default(0)

  // Payment details
  paymentPlan      PaymentPlan?
  tranche1Amount   Float?
  tranche1Date     DateTime?
  tranche2Amount   Float?
  tranche2Date     DateTime?
  tranche3Amount   Float?
  tranche3Date     DateTime?
  totalAmount      Float?
  monthlyPayment   Float?

  // Study period
  studyStartDate   DateTime?
  studyEndDate     DateTime?

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  coordinatorId    String?

  // Relations
  user             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent           Parent?               @relation(fields: [parentId], references: [id])
  gradeLevel       RefGradeLevel?        @relation(fields: [gradeLevelId], references: [id])
  language         RefLanguage?          @relation(fields: [languageId], references: [id])
  studyDirection   RefStudyDirection?    @relation(fields: [studyDirectionId], references: [id])
  city             RefCity?              @relation(fields: [cityId], references: [id])
  school           RefSchool?            @relation(fields: [schoolId], references: [id])
  branch           Branch?               @relation(fields: [branchId], references: [id])

  subjects         StudentSubject[]
  specialNeeds     StudentSpecialNeed[]
  groupStudents    GroupStudent[]
  homeworkSubmissions HomeworkSubmission[]
  testAttempts     TestAttempt[]
  payments         Payment[]
  contracts        Contract[]
  storeOrders      StoreOrder[]
  currencyTransactions CurrencyTransaction[]

  @@index([status])
  @@index([branchId, status])
  @@index([gradeLevelId])
  @@index([studyDirectionId])
  @@map("students")
}

// Связь ученик-предмет
model StudentSubject {
  id        String   @id @default(uuid())
  studentId String
  subjectId String
  createdAt DateTime @default(now())

  student   Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject   RefSubject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([studentId, subjectId])
  @@map("student_subjects")
}

// Связь ученик-особенности
model StudentSpecialNeed {
  id            String   @id @default(uuid())
  studentId     String
  specialNeedId String
  createdAt     DateTime @default(now())

  student       Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  specialNeed   RefSpecialNeed @relation(fields: [specialNeedId], references: [id], onDelete: Cascade)

  @@unique([studentId, specialNeedId])
  @@map("student_special_needs")
}

model Teacher {
  id              String           @id @default(uuid())
  userId          String           @unique
  dateOfBirth     DateTime?
  iin             String?
  phone           String?
  categoryId      String?
  status          TeacherStatus    @default(ACTIVE)
  bio             String?
  education       String?
  experience      Int?
  salaryFormat    SalaryFormat?
  salaryAmount    Float?
  hireDate        DateTime         @default(now())
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  category        RefTeacherCategory?  @relation(fields: [categoryId], references: [id])
  subjects        TeacherSubject[]
  branches        TeacherBranch[]
  groups          Group[]
  lessons         Lesson[]
  scheduleSlots   ScheduleSlot[]

  @@index([status, isActive])
  @@map("teachers")
}

// Связь преподаватель-предмет
model TeacherSubject {
  id        String   @id @default(uuid())
  teacherId String
  subjectId String
  createdAt DateTime @default(now())

  teacher   Teacher    @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  subject   RefSubject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([teacherId, subjectId])
  @@map("teacher_subjects")
}

// Связь преподаватель-филиал
model TeacherBranch {
  id        String   @id @default(uuid())
  teacherId String
  branchId  String
  createdAt DateTime @default(now())

  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  branch    Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([teacherId, branchId])
  @@map("teacher_branches")
}

model Parent {
  id          String    @id @default(uuid())
  userId      String    @unique
  occupation  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  students    Student[]

  @@map("parents")
}

// ==========================================
// BRANCH AND CLASSROOM
// ==========================================

model Branch {
  id          String      @id @default(uuid())
  name        String      @unique
  nameKz      String?
  nameRu      String?
  nameEn      String?
  code        String?
  address     String?
  phone       String?
  latitude    Float?
  longitude   Float?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  classrooms    Classroom[]
  curators      BranchCurator[]
  teachers      TeacherBranch[]
  students      Student[]
  groups        Group[]
  scheduleSlots ScheduleSlot[]

  @@map("branches")
}

// Связь филиал-куратор
model BranchCurator {
  id        String   @id @default(uuid())
  branchId  String
  curatorId String
  createdAt DateTime @default(now())

  branch    Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  curator   Curator @relation(fields: [curatorId], references: [id], onDelete: Cascade)

  @@unique([branchId, curatorId])
  @@map("branch_curators")
}

model Classroom {
  id          String    @id @default(uuid())
  branchId    String
  name        String
  nameKz      String?
  nameRu      String?
  nameEn      String?
  capacity    Int       @default(15)
  equipment   String[]  @default([])
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  branch      Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  scheduleSlots ScheduleSlot[]

  @@unique([branchId, name])
  @@map("classrooms")
}

// ==========================================
// GROUPS
// ==========================================

model Group {
  id              String      @id @default(uuid())
  name            String      // Auto-generated: 5RMD-Omega-O
  gradeLevelId    String?
  languageId      String?
  studyDirectionId String?
  groupIndexId    String?
  branchId        String?
  teacherId       String?
  courseId        String?
  studyFormat     StudyFormat?
  timeOfDay       TimeOfDay?
  maxStudents     Int         @default(15)
  maxHoursPerWeek Int         @default(9)
  startDate       DateTime?
  endDate         DateTime?
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  gradeLevel      RefGradeLevel?     @relation(fields: [gradeLevelId], references: [id])
  language        RefLanguage?       @relation(fields: [languageId], references: [id])
  studyDirection  RefStudyDirection? @relation(fields: [studyDirectionId], references: [id])
  groupIndex      RefGroupIndex?     @relation(fields: [groupIndexId], references: [id])
  branch          Branch?            @relation(fields: [branchId], references: [id])
  teacher         Teacher?           @relation(fields: [teacherId], references: [id])
  course          Course?            @relation(fields: [courseId], references: [id])

  subjects        GroupSubject[]
  students        GroupStudent[]
  schedule        Schedule[]
  homework        Homework[]
  tests           Test[]
  chat            Chat?
  scheduleSlots   ScheduleSlot[]

  @@index([branchId, isActive])
  @@index([teacherId])
  @@index([gradeLevelId])
  @@index([studyDirectionId])
  @@map("groups")
}

// Связь группа-предмет с часами
model GroupSubject {
  id              String   @id @default(uuid())
  groupId         String
  subjectId       String
  hoursPerWeek    Int      @default(0)
  totalHours      Int      @default(0)
  isScheduled     Boolean  @default(false)
  createdAt       DateTime @default(now())

  group           Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  subject         RefSubject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([groupId, subjectId])
  @@map("group_subjects")
}

model GroupStudent {
  id          String    @id @default(uuid())
  groupId     String
  studentId   String
  enrolledAt  DateTime  @default(now())
  completedAt DateTime?

  group       Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([groupId, studentId])
  @@index([studentId])
  @@map("group_students")
}

// ==========================================
// EDUCATIONAL STRUCTURE
// ==========================================

model Course {
  id              String    @id @default(uuid())
  title           String
  description     String?
  difficultyLevel DifficultyLevel
  language        String
  duration        Int
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  topics          Topic[]
  groups          Group[]

  @@map("courses")
}

model Topic {
  id          String    @id @default(uuid())
  courseId    String
  title       String
  description String?
  orderIndex  Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]

  @@map("topics")
}

// ==========================================
// TASK LIBRARY (Keep existing structure)
// ==========================================

model TaskSubject {
  id          String        @id @default(uuid())
  name        String        @unique
  nameKz      String?
  nameRu      String?
  nameEn      String?
  icon        String?
  orderIndex  Int
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  taskTopics     TaskTopic[]
  generatedTests GeneratedTest[]

  @@map("task_subjects")
}

model TaskTopic {
  id          String        @id @default(uuid())
  subjectId   String
  name        String
  nameKz      String?
  nameRu      String?
  nameEn      String?
  icon        String?
  orderIndex  Int
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  subject     TaskSubject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  subtopics   TaskSubtopic[]

  @@index([subjectId])
  @@map("task_topics")
}

model TaskSubtopic {
  id          String        @id @default(uuid())
  topicId     String
  name        String
  nameKz      String?
  nameRu      String?
  nameEn      String?
  orderIndex  Int
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  topic       TaskTopic     @relation(fields: [topicId], references: [id], onDelete: Cascade)
  tasks       Task[]        // Legacy relation
  taskLinks   TaskSubtopicLink[]

  @@index([topicId])
  @@map("task_subtopics")
}

model Task {
  id              String          @id @default(uuid())
  subtopicId      String?         // Legacy field - now using TaskSubtopicLink for multiple topics
  format          TaskFormat
  difficultyLevel DifficultyLevel

  // Question text with multi-language support
  questionText    String
  questionTextKz  String?
  questionTextRu  String?
  questionTextEn  String?
  questionImage   String?

  // Answer options for multiple choice (JSON array with multi-language support)
  // Format: [{ "kz": "...", "ru": "...", "en": "..." }, ...]
  options         Json?

  // Answer text with multi-language support
  answerText      String?
  answerTextKz    String?
  answerTextRu    String?
  answerTextEn    String?
  answerImage     String?

  // Solution text with multi-language support
  solutionText    String?
  solutionTextKz  String?
  solutionTextRu  String?
  solutionTextEn  String?
  solutionImage   String?

  correctAnswer   Int?            // Index of correct answer for multiple choice (0-based)

  // Hints with multi-language support
  hints           String[]        @default([])
  hintsKz         String[]        @default([])
  hintsRu         String[]        @default([])
  hintsEn         String[]        @default([])

  tags            String[]        @default([])
  points          Int             @default(1)
  timeEstimate    Int?
  createdBy       String?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  subtopic        TaskSubtopic?   @relation(fields: [subtopicId], references: [id], onDelete: Cascade)
  subtopics       TaskSubtopicLink[]

  @@index([subtopicId])
  @@index([format, difficultyLevel])
  @@index([isActive])
  @@map("tasks")
}

// Junction table for Task <-> TaskSubtopic many-to-many relationship
model TaskSubtopicLink {
  id          String       @id @default(uuid())
  taskId      String
  subtopicId  String
  createdAt   DateTime     @default(now())

  task        Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)
  subtopic    TaskSubtopic @relation(fields: [subtopicId], references: [id], onDelete: Cascade)

  @@unique([taskId, subtopicId])
  @@map("task_subtopic_links")
}

// ==========================================
// SCHEDULE
// ==========================================

model ScheduleSlot {
  id          String    @id @default(uuid())
  branchId    String
  classroomId String
  groupId     String?
  teacherId   String?
  subject     String?
  dayOfWeek   Int
  startTime   String
  endTime     String
  color       String?
  notes       String?
  isRecurring Boolean   @default(true)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  branch      Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  classroom   Classroom  @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  group       Group?     @relation(fields: [groupId], references: [id], onDelete: SetNull)
  teacher     Teacher?   @relation(fields: [teacherId], references: [id], onDelete: SetNull)

  @@index([branchId, dayOfWeek])
  @@index([classroomId, dayOfWeek])
  @@index([teacherId])
  @@map("schedule_slots")
}

model Schedule {
  id          String    @id @default(uuid())
  groupId     String
  dayOfWeek   Int
  startTime   String
  endTime     String
  room        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  group       Group           @relation(fields: [groupId], references: [id], onDelete: Cascade)
  lessons     LessonSchedule[]

  @@map("schedule")
}

// ==========================================
// LESSONS
// ==========================================

model Lesson {
  id          String     @id @default(uuid())
  topicId     String
  teacherId   String
  title       String
  description String?
  type        LessonType @default(THEORETICAL)
  duration    Int
  materials   String[]
  orderIndex  Int
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  topic       Topic             @relation(fields: [topicId], references: [id], onDelete: Cascade)
  teacher     Teacher           @relation(fields: [teacherId], references: [id])
  schedules   LessonSchedule[]

  @@map("lessons")
}

model LessonSchedule {
  id          String    @id @default(uuid())
  lessonId    String
  scheduleId  String
  date        DateTime
  isCompleted Boolean   @default(false)
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  schedule    Schedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@map("lessons_schedule")
}

// ==========================================
// HOMEWORK
// ==========================================

model Homework {
  id          String    @id @default(uuid())
  groupId     String
  title       String
  description String
  dueDate     DateTime
  maxScore    Int       @default(100)
  attachments String[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  group       Group                 @relation(fields: [groupId], references: [id], onDelete: Cascade)
  submissions HomeworkSubmission[]

  @@index([groupId])
  @@index([dueDate])
  @@map("homework")
}

model HomeworkSubmission {
  id          String         @id @default(uuid())
  homeworkId  String
  studentId   String
  content     String
  attachments String[]
  status      HomeworkStatus @default(PENDING)
  score       Int?
  feedback    String?
  submittedAt DateTime       @default(now())
  checkedAt   DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  homework    Homework  @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([homeworkId, studentId])
  @@index([studentId, status])
  @@map("homework_submissions")
}

// ==========================================
// TESTS
// ==========================================

model TaskBank {
  id             String       @id @default(uuid())
  question       String
  questionType   QuestionType
  difficultyLevel DifficultyLevel
  topic          String
  correctAnswer  String
  options        String[]
  explanation    String?
  points         Int          @default(1)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  testQuestions  TestQuestion[]

  @@map("task_bank")
}

model Test {
  id          String    @id @default(uuid())
  groupId     String
  createdById String
  title       String
  description String?
  type        TestType
  duration    Int
  totalScore  Int
  passingScore Int
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  group       Group          @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdBy   User           @relation(fields: [createdById], references: [id])
  questions   TestQuestion[]
  attempts    TestAttempt[]

  @@index([groupId])
  @@index([isActive, startDate])
  @@map("tests")
}

model TestQuestion {
  id          String    @id @default(uuid())
  testId      String
  taskId      String
  orderIndex  Int
  points      Int       @default(1)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  test        Test      @relation(fields: [testId], references: [id], onDelete: Cascade)
  task        TaskBank  @relation(fields: [taskId], references: [id])

  @@unique([testId, taskId])
  @@map("test_questions")
}

model TestAttempt {
  id          String    @id @default(uuid())
  testId      String
  studentId   String
  answers     Json
  score       Int?
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  test        Test      @relation(fields: [testId], references: [id], onDelete: Cascade)
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@index([studentId])
  @@map("test_attempts")
}

// ==========================================
// PAYMENTS AND CONTRACTS
// ==========================================

model Payment {
  id            String        @id @default(uuid())
  studentId     String
  amount        Float
  actualAmount  Float?
  method        String
  status        PaymentStatus @default(PENDING)
  description   String?
  dueDate       DateTime?
  paidAt        DateTime?

  coordinatorId String?
  partnerId     String?
  confirmedById String?
  confirmedAt   DateTime?
  isConfirmed   Boolean       @default(false)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  student       Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  coordinator   User?     @relation("RecordedPayments", fields: [coordinatorId], references: [id])
  partner       User?     @relation("PartnerPayments", fields: [partnerId], references: [id])
  confirmedBy   User?     @relation("ConfirmedPayments", fields: [confirmedById], references: [id])

  @@index([studentId, status])
  @@index([status, dueDate])
  @@index([coordinatorId])
  @@index([isConfirmed])
  @@map("payments")
}

model Contract {
  id          String         @id @default(uuid())
  studentId   String
  contractNumber String      @unique
  startDate   DateTime
  endDate     DateTime
  totalAmount Float
  status      ContractStatus @default(DRAFT)
  terms       String
  signedAt    DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("contracts")
}

// ==========================================
// LIBRARY
// ==========================================

model Library {
  id          String       @id @default(uuid())
  title       String
  description String?
  type        ResourceType
  fileUrl     String
  thumbnail   String?
  subject     String?
  tags        String[]
  downloads   Int          @default(0)
  isPublic    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("library")
}

// ==========================================
// STORE AND CURRENCY
// ==========================================

model StoreProduct {
  id          String    @id @default(uuid())
  title       String
  description String?
  price       Int
  imageUrl    String?
  category    String?
  stock       Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  orders      StoreOrder[]

  @@map("store_products")
}

model StoreOrder {
  id          String      @id @default(uuid())
  studentId   String
  productId   String
  quantity    Int         @default(1)
  totalPrice  Int
  status      OrderStatus @default(PENDING)
  completedAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  student     Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  product     StoreProduct @relation(fields: [productId], references: [id])

  @@map("store_orders")
}

model CurrencyTransaction {
  id          String          @id @default(uuid())
  studentId   String
  amount      Int
  type        TransactionType
  description String?
  relatedId   String?
  createdAt   DateTime        @default(now())

  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([createdAt])
  @@map("currency_transactions")
}

// ==========================================
// COMMUNICATION
// ==========================================

model Chat {
  id          String    @id @default(uuid())
  groupId     String?   @unique
  name        String?
  isGroup     Boolean   @default(false)
  isBroadcast Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  group       Group?            @relation(fields: [groupId], references: [id], onDelete: Cascade)
  participants ChatParticipant[]
  messages    Message[]

  @@map("chats")
}

model ChatParticipant {
  id          String    @id @default(uuid())
  chatId      String
  userId      String
  joinedAt    DateTime  @default(now())

  chat        Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatId, userId])
  @@map("chat_participants")
}

model Message {
  id               String        @id @default(uuid())
  chatId           String
  senderId         String
  content          String
  attachments      String[]
  status           MessageStatus @default(SENT)
  isEdited         Boolean       @default(false)
  broadcastFilters Json?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  chat                Chat                       @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender              User                       @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  broadcastRecipients BroadcastMessageRecipient[]

  @@index([chatId, createdAt])
  @@index([senderId])
  @@map("messages")
}

model BroadcastMessageRecipient {
  id        String    @id @default(uuid())
  messageId String
  userId    String
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  message   Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId, isRead])
  @@index([messageId])
  @@map("broadcast_message_recipients")
}

model Notification {
  id          String           @id @default(uuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  isRead      Boolean          @default(false)
  relatedId   String?
  createdAt   DateTime         @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ==========================================
// GENERATED TESTS (Мои тесты / My Tests)
// ==========================================

enum GeneratedTestFormat {
  TEST
  EXAM
}

model GeneratedTest {
  id              String                 @id @default(uuid())
  title           String
  titleKz         String?
  titleEn         String?
  format          GeneratedTestFormat    @default(TEST)
  subjectId       String?
  gradeLevel      Int?
  createdById     String
  duration        Int?
  taskIds         Json                   // Array of task IDs
  topicIds        Json?                  // Array of selected topic IDs
  difficultyConfig Json?                 // { easy: number, medium: number, hard: number }
  isShared        Boolean                @default(false)
  isDiagnostic    Boolean                @default(false) // true = diagnostic test, false = regular test
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  subject         TaskSubject?           @relation(fields: [subjectId], references: [id])
  createdBy       User                   @relation("CreatedGeneratedTests", fields: [createdById], references: [id], onDelete: Cascade)
  sharedWith      GeneratedTestShare[]
  blankResults    BlankResult[]

  @@index([createdById])
  @@index([subjectId])
  @@index([createdAt])
  @@index([isDiagnostic])
  @@map("generated_tests")
}

model BlankResult {
  id              String        @id @default(uuid())
  generatedTestId String
  studentName     String?
  studentClass    String?
  answers         Json          // Array of answers: [0, 1, 2, 3, 4, null...]
  correctCount    Int
  totalQuestions  Int
  percentage      Float
  scannedImageUrl String?
  scannedAt       DateTime      @default(now())
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  generatedTest   GeneratedTest @relation(fields: [generatedTestId], references: [id], onDelete: Cascade)

  @@index([generatedTestId])
  @@index([scannedAt])
  @@map("blank_results")
}

model GeneratedTestShare {
  id              String        @id @default(uuid())
  generatedTestId String
  sharedWithId    String
  canEdit         Boolean       @default(false)
  createdAt       DateTime      @default(now())

  generatedTest   GeneratedTest @relation(fields: [generatedTestId], references: [id], onDelete: Cascade)
  sharedWith      User          @relation("SharedGeneratedTests", fields: [sharedWithId], references: [id], onDelete: Cascade)

  @@unique([generatedTestId, sharedWithId])
  @@map("generated_test_shares")
}

// ── CRM ──

// Legacy enum - kept for backwards compatibility during migration
enum CrmLeadStage {
  NEW_APPLICATION
  INITIAL_CONTACT
  DIAGNOSTIC
  NEGOTIATION
  CONTRACT
  PAYMENT
  WON
  LOST
}

model CrmFunnel {
  id          String     @id @default(uuid())
  name        String
  description String?
  color       String     @default("#3B82F6") // blue-500
  isDefault   Boolean    @default(false)
  isActive    Boolean    @default(true)
  order       Int        @default(0)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  stages      CrmStage[]
  leads       CrmLead[]

  @@map("crm_funnels")
}

model CrmStage {
  id          String     @id @default(uuid())
  funnelId    String
  funnel      CrmFunnel  @relation(fields: [funnelId], references: [id], onDelete: Cascade)

  name        String
  color       String     @default("#6B7280") // gray-500
  order       Int        @default(0)
  isWon       Boolean    @default(false)  // Final positive stage
  isLost      Boolean    @default(false)  // Final negative stage
  isSystem    Boolean    @default(false)  // System stage (cannot be deleted)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  leads       CrmLead[]

  @@index([funnelId])
  @@map("crm_stages")
}

model CrmLead {
  id            String        @id @default(uuid())
  firstName     String
  lastName      String
  phone         String?
  email         String?
  parentName    String?
  parentPhone   String?
  source        String?

  // New funnel-based stage system
  funnelId      String?
  funnel        CrmFunnel?    @relation(fields: [funnelId], references: [id])
  stageId       String?
  stage_rel     CrmStage?     @relation(fields: [stageId], references: [id])

  // Legacy stage - for backwards compatibility
  stage         CrmLeadStage  @default(NEW_APPLICATION)

  amount        Float?
  description   String?
  lostReason    String?
  language      String?

  // Student profile (Анкетные данные ученика)
  studentName     String?       // ФИО ученика
  studentPhone    String?       // Номер ученика
  gradeLevelId    String?       // Класс
  gradeLevel      RefGradeLevel? @relation(fields: [gradeLevelId], references: [id])
  studyLanguageId String?       // Язык обучения
  studyLanguage   RefLanguage?  @relation("CrmLeadStudyLanguage", fields: [studyLanguageId], references: [id])
  goal            String?       // Цель
  regionId        String?       // Область
  region          RefRegion?    @relation(fields: [regionId], references: [id])
  cityId          String?       // Город
  city            RefCity?      @relation(fields: [cityId], references: [id])
  schoolId        String?       // Школа
  school          RefSchool?    @relation(fields: [schoolId], references: [id])

  // Pre-consultation notes (Заметки до консультации)
  meetingAt       DateTime?     // Встреча (дата и время)
  bonus           String?       // Бонус (read-only from API)

  coordinatorId String?
  coordinator   User?         @relation("CrmLeads", fields: [coordinatorId], references: [id])

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  whatsappConversation WhatsAppConversation?
  socialConversations  SocialConversation[]

  @@index([stage])
  @@index([funnelId])
  @@index([stageId])
  @@index([coordinatorId])
  @@index([gradeLevelId])
  @@index([studyLanguageId])
  @@index([regionId])
  @@index([cityId])
  @@index([schoolId])
  @@map("crm_leads")
}

// ── WhatsApp ──

model WhatsAppConversation {
  id            String   @id @default(uuid())
  waId          String   @unique  // WhatsApp ID (phone number without +, e.g. "77007501414")
  contactName   String?           // Profile name from WhatsApp
  contactPhone  String             // Phone in original format

  leadId        String?  @unique
  lead          CrmLead? @relation(fields: [leadId], references: [id], onDelete: SetNull)

  lastMessageAt DateTime?
  unreadCount   Int      @default(0)
  isBlocked     Boolean  @default(false)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  messages      WhatsAppMessage[]

  @@index([lastMessageAt])
  @@map("whatsapp_conversations")
}

model WhatsAppMessage {
  id              String   @id @default(uuid())
  conversationId  String
  waMessageId     String?  @unique  // WhatsApp message ID from Meta API
  direction       WhatsAppMessageDirection
  type            WhatsAppMessageType @default(TEXT)

  body            String?           // Text content
  mediaUrl        String?           // URL for media (image, audio, video, document)
  mediaCaption    String?
  mediaMimeType   String?
  mediaFileName   String?

  status          WhatsAppMessageStatus @default(SENT)

  sentById        String?           // User who sent outgoing message
  sentBy          User?   @relation("WhatsAppSentBy", fields: [sentById], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  conversation    WhatsAppConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([waMessageId])
  @@map("whatsapp_messages")
}

enum WhatsAppMessageDirection {
  INCOMING
  OUTGOING
}

enum WhatsAppMessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  DOCUMENT
  STICKER
  LOCATION
  CONTACT
  REACTION
  TEMPLATE
  UNKNOWN
}

enum WhatsAppMessageStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

// ── Social Messaging (Facebook Messenger + Instagram) ──

enum SocialPlatform {
  MESSENGER
  INSTAGRAM
}

model SocialConversation {
  id              String           @id @default(uuid())
  platform        SocialPlatform
  platformUserId  String           // PSID (Messenger) or IGSID (Instagram)
  contactName     String?
  contactUsername  String?          // Instagram @handle (empty for Messenger)
  contactAvatar   String?          // Profile picture URL

  leadId          String?
  lead            CrmLead?         @relation(fields: [leadId], references: [id], onDelete: SetNull)

  lastMessageAt   DateTime?
  unreadCount     Int              @default(0)
  isBlocked       Boolean          @default(false)

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  messages        SocialMessage[]

  @@unique([platform, platformUserId])
  @@index([leadId])
  @@index([lastMessageAt])
  @@map("social_conversations")
}

model SocialMessage {
  id              String                  @id @default(uuid())
  conversationId  String
  platformMsgId   String?                 // mid from Meta API
  direction       WhatsAppMessageDirection
  type            WhatsAppMessageType     @default(TEXT)

  body            String?
  mediaUrl        String?
  mediaCaption    String?
  mediaMimeType   String?
  mediaFileName   String?

  status          WhatsAppMessageStatus   @default(SENT)

  sentById        String?
  sentBy          User?                   @relation("SocialSentBy", fields: [sentById], references: [id])

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  conversation    SocialConversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([platformMsgId])
  @@map("social_messages")
}

// ── CRM Settings ──

// General CRM settings (key-value store)
model CrmSettings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("crm_settings")
}

// ── MarSIP (SIP Telephony Integration) ──
// ACTIVATION NOTE: MarSIP is configured but NOT active until Tele2/Altel grants access (1-3 business days).
// When user says "активируй marsip", set isActive=true in MarSipConfig.
// Credentials: Server: almpbx.tele2.kz or astpbx.tele2.kz, Login: 7tiWgPpD, Password: dMptY92o

model MarSipConfig {
  id                String   @id @default(uuid())

  // Connection
  sipServer         String   @default("almpbx.tele2.kz")  // almpbx.tele2.kz (Almaty) or astpbx.tele2.kz (Astana)
  sipLogin          String?
  sipPassword       String?
  sipPort           Int      @default(5060)

  // Features
  isActive          Boolean  @default(false)  // DO NOT activate until Tele2 grants access
  recordCalls       Boolean  @default(true)
  autoCreateLead    Boolean  @default(true)   // Auto-create lead on incoming call from unknown number
  showLeadCard      Boolean  @default(true)   // Show lead card popup on incoming call
  logCallsToLead    Boolean  @default(true)   // Log calls to lead history

  // Call settings
  ringTimeout       Int      @default(30)     // Seconds to wait before forwarding
  forwardNumber     String?                   // Forward calls to this number if no answer
  voicemailEnabled  Boolean  @default(false)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  extensions        MarSipExtension[]

  @@map("marsip_config")
}

model MarSipExtension {
  id              String   @id @default(uuid())
  configId        String

  extensionNumber String            // Internal number (201, 202, 207, etc.)
  sipPassword     String?           // SIP password for this extension
  displayName     String?           // Display name for this extension
  userId          String?  @unique  // Linked system user

  // Status
  isActive        Boolean  @default(true)
  isOnline        Boolean  @default(false)

  // Personal settings
  forwardNumber   String?           // Personal forward number
  voicemailEnabled Boolean @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  config          MarSipConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, extensionNumber])
  @@index([userId])
  @@map("marsip_extensions")
}

// Call history for MarSIP
model MarSipCall {
  id              String   @id @default(uuid())

  direction       String   // INCOMING, OUTGOING
  callerNumber    String
  callerName      String?
  receiverNumber  String
  receiverName    String?
  extensionNumber String?

  status          String   // ANSWERED, MISSED, BUSY, FAILED
  duration        Int      @default(0)  // Duration in seconds
  recordingUrl    String?

  leadId          String?  // Linked lead if any
  userId          String?  // User who handled the call

  startedAt       DateTime
  answeredAt      DateTime?
  endedAt         DateTime?

  createdAt       DateTime @default(now())

  @@index([leadId])
  @@index([userId])
  @@index([callerNumber])
  @@index([startedAt])
  @@map("marsip_calls")
}
